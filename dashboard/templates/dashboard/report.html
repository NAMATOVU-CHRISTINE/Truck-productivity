{% extends 'dashboard/base.html' %}

{% block title %}Productivity Report - Truck Productivity Dashboard{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar"></i> Productivity Report
        </h1>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filters</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date</label>
                        <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Depot</label>
                        <select name="depot" class="form-control">
                            <option value="">All Depots</option>
                            {% for depot in depots %}
                                <option value="{{ depot }}" {% if request.GET.depot == depot %}selected{% endif %}>
                                    {{ depot }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i> Filter
                        </button>
                        <a href="{% url 'dashboard:export' %}?{{ request.GET.urlencode }}" class="btn btn-success">
                            <i class="fas fa-download"></i> Export
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
{% if charts %}
<div class="row mb-4">
    {% if charts.depot_performance %}
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5>Depot Performance</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    {{ charts.depot_performance|safe }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if charts.time_vs_distance %}
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5>Time vs Distance Performance</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    {{ charts.time_vs_distance|safe }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Performance Data Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-table"></i> Performance Data</h5>
                <span class="badge bg-primary">{{ performance_data|length }} records</span>
            </div>
            <div class="card-body">
                {% if performance_data %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="performanceTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Load Name</th>
                                <th>Depot</th>
                                <th>Driver</th>
                                <th>Customer</th>
                                <th>Time Diff (min)</th>
                                <th>Distance Diff (km)</th>
                                <th>Efficiency Score</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in performance_data %}
                            <tr>
                                <td>{{ record.schedule_date|date:"M d, Y" }}</td>
                                <td><strong>{{ record.load_name }}</strong></td>
                                <td>{{ record.depot }}</td>
                                <td>{{ record.driver_name|default:"-" }}</td>
                                <td class="text-truncate" style="max-width: 200px;" title="{{ record.customer }}">
                                    {{ record.customer|truncatechars:30 }}
                                </td>
                                <td>
                                    {% if record.time_difference is not None %}
                                        <span class="badge bg-{% if record.time_difference <= 0 %}success{% elif record.time_difference <= 60 %}warning{% else %}danger{% endif %}">
                                            {{ record.time_difference|floatformat:0 }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.distance_difference is not None %}
                                        <span class="badge bg-{% if record.distance_difference <= 0 %}success{% elif record.distance_difference <= 10 %}warning{% else %}danger{% endif %}">
                                            {{ record.distance_difference|floatformat:1 }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.efficiency_score %}
                                        <div class="progress" style="height: 20px; width: 80px;">
                                            <div class="progress-bar 
                                                {% if record.efficiency_score >= 80 %}bg-success
                                                {% elif record.efficiency_score >= 60 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                style="width: {{ record.efficiency_score }}%;">
                                                {{ record.efficiency_score|floatformat:0 }}%
                                            </div>
                                        </div>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.on_time is not None %}
                                        {% if record.on_time %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> On Time
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-clock"></i> Delayed
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">Unknown</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination would go here if needed -->
                {% if performance_data|length > 50 %}
                <div class="mt-3">
                    <p class="text-muted">Showing first 50 records. Use filters to narrow down results.</p>
                </div>
                {% endif %}
                
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                    <h5>No performance data found</h5>
                    <p class="text-muted">Try adjusting your filters or upload more data files.</p>
                    <a href="{% url 'dashboard:upload' %}" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload Data
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if performance_data %}
<script>
    // Add search functionality to the table
    document.addEventListener('DOMContentLoaded', function() {
        // Simple table search (you could use DataTables for more advanced features)
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'form-control mb-3';
        searchInput.placeholder = 'Search table...';
        
        const table = document.getElementById('performanceTable');
        table.parentNode.insertBefore(searchInput, table);
        
        searchInput.addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            }
        });
    });
</script>
{% endif %}
{% endblock %}
